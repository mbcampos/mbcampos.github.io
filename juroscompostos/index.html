<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora de Juros Compostos</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="apple-touch-icon" href="favicon.svg">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: #f8f9fb;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
      margin: 0;
      min-height: 100vh;
    }

    .container {
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0px 3px 12px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 600px;
    }

    h1 {
      font-size: 22px;
      margin-bottom: 10px;
      color: #2c3e50;
      text-align: center;
    }

    p {
      font-size: 14px;
      color: #555;
      margin-bottom: 20px;
      text-align: center;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      font-size: 14px;
      margin-bottom: 6px;
      color: #333;
    }

    .input-group input, .input-group select {
      width: 100%;
      padding: 12px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .periodo-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .periodo-group select {
      width: 35%;
      flex-shrink: 0;
    }

    .periodo-group input {
      width: 65%;
      flex-grow: 1;
    }

    .btn {
      width: 100%;
      background: #3949ab;
      color: #fff;
      padding: 15px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
      transition: background-color 0.3s;
    }

    .btn:hover {
      background: #303f9f;
    }

    .resultado {
      margin-top: 20px;
      font-size: 16px;
      font-weight: bold;
      color: #2c3e50;
      padding: 12px;
      background: #ecf0f1;
      border-radius: 6px;
      word-break: break-word;
      display: none; /* Inicialmente oculto */
    }

    .erro {
      margin-top: 20px;
      font-size: 14px;
      color: #e74c3c;
      padding: 12px;
      background: #fdf2f2;
      border: 1px solid #f5c6cb;
      border-radius: 6px;
      display: none;
      white-space: pre-line;
    }

    .input-group input.erro-campo, .input-group select.erro-campo {
      border-color: #e74c3c;
      background-color: #fdf2f2;
    }

    /* Abas de modo de cálculo */
    .modo-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }

    .modo-tab {
      flex: 1;
      padding: 12px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      font-size: 14px;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      transition: all 0.3s;
    }

    .modo-tab:hover {
      color: #3949ab;
      background: #f5f5f5;
    }

    .modo-tab.ativo {
      color: #3949ab;
      border-bottom-color: #3949ab;
      background: #f5f5f5;
    }

    .modo-conteudo {
      display: none;
    }

    .modo-conteudo.ativo {
      display: block;
    }

    canvas {
      margin-top: 20px;
      max-width: 100%;
      height: auto;
      display: none; /* Inicialmente oculto */
    }

    /* RESPONSIVIDADE PARA SMARTPHONES */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .container {
        padding: 20px;
        margin: 10px;
        border-radius: 8px;
      }

      h1 {
        font-size: 20px;
        margin-bottom: 8px;
      }

      p {
        font-size: 13px;
        margin-bottom: 15px;
      }

      .input-group {
        margin-bottom: 18px;
      }

      .input-group label {
        font-size: 13px;
        margin-bottom: 8px;
        font-weight: 600;
      }

      .input-group input, .input-group select {
        padding: 14px;
        font-size: 16px; /* Evita zoom no iOS */
        border-width: 2px;
      }

      .periodo-group {
        gap: 8px;
      }

      .periodo-group select {
        width: 40%;
      }

      .periodo-group input {
        width: 60%;
      }

      .btn {
        padding: 18px;
        font-size: 18px;
        margin-top: 15px;
        border-radius: 8px;
      }

      .resultado {
        font-size: 15px;
        padding: 15px;
        margin-top: 15px;
        text-align: center;
      }

      .erro {
        font-size: 13px;
        padding: 15px;
        margin-top: 15px;
      }

      canvas {
        margin-top: 15px;
      }
      .modo-tab {
        font-size: 13px;
        padding: 10px 8px;
      }
    }

    /* RESPONSIVIDADE PARA SMARTPHONES PEQUENOS */
    @media (max-width: 480px) {
      body {
        padding: 8px;
      }

      .container {
        padding: 15px;
        margin: 5px;
      }

      h1 {
        font-size: 18px;
      }

      .input-group input, .input-group select {
        padding: 12px;
      }

      .periodo-group {
        flex-direction: column;
        gap: 12px;
      }

      .periodo-group select,
      .periodo-group input {
        width: 100%;
      }

      .btn {
        padding: 16px;
        font-size: 16px;
      }
    }

    /* RESPONSIVIDADE PARA TABLETS */
    @media (min-width: 769px) and (max-width: 1024px) {
      .container {
        max-width: 700px;
        padding: 35px;
      }

      h1 {
        font-size: 24px;
      }

      .input-group input, .input-group select {
        padding: 12px;
        font-size: 15px;
      }
    }

    /* RESPONSIVIDADE PARA DESKTOPS GRANDES */
    @media (min-width: 1200px) {
      .container {
        max-width: 800px;
        padding: 40px;
      }

      h1 {
        font-size: 26px;
      }

      .input-group input, .input-group select {
        padding: 14px;
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Calculadora de Juros Compostos</h1>
    <p>Simule o crescimento do seu investimento com juros compostos.</p>

    <!-- Abas de seleção de modo -->
    <div class="modo-tabs">
      <button class="modo-tab ativo" onclick="alternarModo('calcular')">Calcular Valor Final</button>
      <button class="modo-tab" onclick="alternarModo('planejamento')">Planejar Investimento</button>
    </div>

    <!-- Modo 1: Calcular valor final (modo atual) -->
    <div id="modo-calcular" class="modo-conteudo ativo">
      <div class="input-group">
        <label>Valor inicial (R$)</label>
        <input type="text" id="valorInicial" placeholder="R$ 10.000,00" oninput="aplicarMascaraMoeda(this)" onblur="aplicarMascaraMoeda(this)">
      </div>

      <div class="input-group">
        <label>Valor mensal (R$)</label>
        <input type="text" id="valorMensal" placeholder="R$ 500,00" oninput="aplicarMascaraMoeda(this)" onblur="aplicarMascaraMoeda(this)">
      </div>

      <div class="input-group">
        <label>Taxa de juros (% ao ano)</label>
        <input type="text" id="taxaJuros" placeholder="12,50%" oninput="aplicarMascaraPorcentagem(this)" onblur="aplicarMascaraPorcentagem(this)">
      </div>

      <div class="input-group">
        <label>Período</label>
        <div class="periodo-group">
          <select id="periodoTipo">
            <option value="anos">Anos</option>
            <option value="meses">Meses</option>
          </select>
          <input type="number" id="periodo" placeholder="Ex: 5">
        </div>
      </div>

      <div class="input-group">
        <label style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="calcularIR" style="width: auto; margin: 0;">
          Calcular com desconto de IR (tabela regressiva)
        </label>
      </div>

      <button class="btn" onclick="calcular()">Calcular</button>
    </div>

    <!-- Modo 2: Planejar investimento (novo) -->
    <div id="modo-planejamento" class="modo-conteudo">
      <div class="input-group">
        <label>Valor final desejado (R$)</label>
        <input type="text" id="valorFinalDesejado" placeholder="R$ 100.000,00" oninput="aplicarMascaraMoeda(this)" onblur="aplicarMascaraMoeda(this)">
      </div>

      <div class="input-group">
        <label>Valor inicial disponível (R$)</label>
        <input type="text" id="valorInicialPlan" placeholder="R$ 10.000,00" oninput="aplicarMascaraMoeda(this)" onblur="aplicarMascaraMoeda(this)">
      </div>

      <div class="input-group">
        <label>Período</label>
        <div class="periodo-group">
          <select id="periodoTipoPlan">
            <option value="anos">Anos</option>
            <option value="meses">Meses</option>
          </select>
          <input type="number" id="periodoPlan" placeholder="Ex: 5">
        </div>
      </div>

      <div class="input-group">
        <label style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="calcularIRPlan" style="width: auto; margin: 0;">
          Calcular com desconto de IR (tabela regressiva)
        </label>
      </div>

      <div class="input-group">
        <label>Calcular:</label>
        <select id="calcularOpcao">
          <option value="aporte">Aporte mensal necessário (com taxa fixa)</option>
          <option value="taxa">Taxa de juros necessária (com aporte fixo)</option>
          <option value="inicial">Valor inicial necessário (sem aportes)</option>
        </select>
      </div>

      <div class="input-group" id="taxaFixaGroup">
        <label>Taxa de juros estimada (% ao ano)</label>
        <input type="text" id="taxaFixa" placeholder="12,50%" oninput="aplicarMascaraPorcentagem(this)" onblur="aplicarMascaraPorcentagem(this)">
      </div>

      <div class="input-group" id="aporteFixoGroup" style="display: none;">
        <label>Aporte mensal fixo (R$)</label>
        <input type="text" id="aporteFixo" placeholder="R$ 500,00" oninput="aplicarMascaraMoeda(this)" onblur="aplicarMascaraMoeda(this)">
      </div>

      <div class="input-group" id="taxaSemAporteGroup" style="display: none;">
        <label>Taxa de juros estimada (% ao ano)</label>
        <input type="text" id="taxaSemAporte" placeholder="12,50%" oninput="aplicarMascaraPorcentagem(this)" onblur="aplicarMascaraPorcentagem(this)">
      </div>

      <button class="btn" onclick="calcularPlanejamento()">Calcular Planejamento</button>
    </div>

    <div class="erro" id="erro"></div>

    <div class="resultado" id="resultado"></div>

    <canvas id="grafico"></canvas>
  </div>

  <script>
    let chart;
    let modoAtual = 'calcular';

    // Função para alternar entre modos
    function alternarModo(modo) {
      // Atualiza modo atual
      modoAtual = modo;
      
      // Limpa resultados e erros
      limparResultado();
      limparErros();
      
      // Atualiza abas
      document.querySelectorAll('.modo-tab').forEach(tab => {
        tab.classList.remove('ativo');
      });
      event.target.classList.add('ativo');
      
      // Atualiza conteúdo
      document.querySelectorAll('.modo-conteudo').forEach(conteudo => {
        conteudo.classList.remove('ativo');
      });
      document.getElementById('modo-' + modo).classList.add('ativo');
    }

    // Função para alternar campos no modo planejamento
    function atualizarCamposPlanejamento() {
      const opcao = document.getElementById('calcularOpcao').value;
      const taxaFixaGroup = document.getElementById('taxaFixaGroup');
      const aporteFixoGroup = document.getElementById('aporteFixoGroup');
      const taxaSemAporteGroup = document.getElementById('taxaSemAporteGroup');
      const valorInicialPlanGroup = document.getElementById('valorInicialPlan').parentElement;
      
      if (opcao === 'aporte') {
        taxaFixaGroup.style.display = 'block';
        aporteFixoGroup.style.display = 'none';
        taxaSemAporteGroup.style.display = 'none';
        valorInicialPlanGroup.style.display = 'block';
      } else if (opcao === 'taxa') {
        taxaFixaGroup.style.display = 'none';
        aporteFixoGroup.style.display = 'block';
        taxaSemAporteGroup.style.display = 'none';
        valorInicialPlanGroup.style.display = 'block';
      } else if (opcao === 'inicial') {
        taxaFixaGroup.style.display = 'none';
        aporteFixoGroup.style.display = 'none';
        taxaSemAporteGroup.style.display = 'block';
        valorInicialPlanGroup.style.display = 'none';
      }
    }

    // Função para aplicar máscara de moeda
    function aplicarMascaraMoeda(input) {
      let valor = input.value;
      
      // Remove tudo que não é número
      valor = valor.replace(/\D/g, '');
      
      if (valor === '') {
        input.value = '';
        return;
      }
      
      // Converte para centavos
      valor = parseFloat(valor) / 100;
      
      // Formata como moeda brasileira
      input.value = 'R$ ' + valor.toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    // Função para aplicar máscara de porcentagem
    function aplicarMascaraPorcentagem(input) {
      let valor = input.value;
      
      // Remove tudo que não é número ou vírgula/ponto
      valor = valor.replace(/[^\d,\.]/g, '');
      
      // Substitui ponto por vírgula para padrão brasileiro
      valor = valor.replace(/\./g, ',');
      
      // Garante apenas uma vírgula
      let partes = valor.split(',');
      if (partes.length > 2) {
        valor = partes[0] + ',' + partes.slice(1).join('');
      }
      
      // Limita casas decimais a 2
      if (partes[1] && partes[1].length > 2) {
        valor = partes[0] + ',' + partes[1].substring(0, 2);
      }
      
      if (valor !== '') {
        input.value = valor + '%';
      } else {
        input.value = '';
      }
    }

    // Função para extrair valor numérico dos campos com máscara
    function extrairValorNumerico(valor, tipo) {
      if (!valor) return 0;
      
      if (tipo === 'moeda') {
        // Remove R$, pontos e substitui vírgula por ponto
        return parseFloat(valor.replace(/R\$\s?/g, '').replace(/\./g, '').replace(/,/g, '.')) || 0;
      } else if (tipo === 'porcentagem') {
        // Remove % e substitui vírgula por ponto
        return parseFloat(valor.replace(/%/g, '').replace(/,/g, '.')) || 0;
      }
      
      return parseFloat(valor) || 0;
    }

    // Função para calcular alíquota de IR pela tabela regressiva
    function calcularAliquotaIR(meses) {
      // Tabela regressiva do IR 2025
      // Convertendo meses para dias (aproximadamente)
      const dias = meses * 30;
      
      if (dias <= 180) {
        return 0.225; // 22,5% - até 180 dias
      } else if (dias <= 360) {
        return 0.20; // 20% - de 181 a 360 dias
      } else if (dias <= 720) {
        return 0.175; // 17,5% - de 361 a 720 dias
      } else {
        return 0.15; // 15% - acima de 720 dias
      }
    }

    // Função para calcular IR sobre o rendimento
    function calcularIR(valorInicial, valorFinal) {
      const rendimento = valorFinal - valorInicial;
      return rendimento > 0 ? rendimento : 0;
    }

    function limparErros() {
      // Remove classes de erro dos campos
      document.querySelectorAll('.erro-campo').forEach(campo => {
        campo.classList.remove('erro-campo');
      });
      
      // Esconde mensagem de erro
      document.getElementById('erro').style.display = 'none';
    }

    function limparResultado() {
      // Esconde o resultado
      document.getElementById('resultado').style.display = 'none';
      
      // Esconde o canvas
      document.getElementById('grafico').style.display = 'none';
      
      // Destroi o gráfico se existir
      if (chart) {
        chart.destroy();
        chart = null;
      }
    }

    function validarCampos() {
      const campos = [
        { id: 'valorInicial', nome: 'Valor inicial', obrigatorio: false },
        { id: 'valorMensal', nome: 'Valor mensal', obrigatorio: false },
        { id: 'taxaJuros', nome: 'Taxa de juros', obrigatorio: true },
        { id: 'periodo', nome: 'Período', obrigatorio: true }
      ];

      let camposComErro = [];
      let valorInicialPreenchido = false;
      let valorMensalPreenchido = false;

      campos.forEach(campo => {
        const elemento = document.getElementById(campo.id);
        const valor = elemento.value.trim();
        let valorNumerico = 0;
        
        // Extrai valor numérico baseado no tipo do campo
        if (campo.id === 'valorInicial' || campo.id === 'valorMensal') {
          valorNumerico = extrairValorNumerico(valor, 'moeda');
        } else if (campo.id === 'taxaJuros') {
          valorNumerico = extrairValorNumerico(valor, 'porcentagem');
        } else {
          valorNumerico = parseFloat(valor);
        }
        
        // Verifica se é obrigatório e está vazio
        if (campo.obrigatorio && (!valor || valorNumerico <= 0)) {
          elemento.classList.add('erro-campo');
          camposComErro.push(campo.nome);
        }
        
        // Verifica se valor inicial ou mensal foram preenchidos
        if (campo.id === 'valorInicial' && valor && valorNumerico > 0) {
          valorInicialPreenchido = true;
        }
        if (campo.id === 'valorMensal' && valor && valorNumerico > 0) {
          valorMensalPreenchido = true;
        }
      });

      // Pelo menos um dos valores (inicial ou mensal) deve ser preenchido
      if (!valorInicialPreenchido && !valorMensalPreenchido) {
        document.getElementById('valorInicial').classList.add('erro-campo');
        document.getElementById('valorMensal').classList.add('erro-campo');
        camposComErro.push('Valor inicial ou Valor mensal (pelo menos um deve ser preenchido)');
      }

      return camposComErro;
    }

    function exibirErro(erros) {
      const divErro = document.getElementById('erro');
      let mensagem = 'Por favor, corrija os seguintes campos:\n';
      erros.forEach(erro => {
        mensagem += '• ' + erro + '\n';
      });
      
      divErro.textContent = mensagem;
      divErro.style.display = 'block';
    }

    function calcular() {
      // Limpa erros anteriores
      limparErros();
      
      // Valida campos
      const erros = validarCampos();
      if (erros.length > 0) {
        exibirErro(erros);
        limparResultado(); // Esconde resultado quando há erro
        return;
      }

      let valorInicial = extrairValorNumerico(document.getElementById('valorInicial').value, 'moeda');
      let valorMensal = extrairValorNumerico(document.getElementById('valorMensal').value, 'moeda');
      let taxaJuros = extrairValorNumerico(document.getElementById('taxaJuros').value, 'porcentagem') / 100;
      let periodo = parseInt(document.getElementById('periodo').value) || 0;
      let periodoTipo = document.getElementById('periodoTipo').value;
      let calcularIRChecked = document.getElementById('calcularIR').checked;

      // Definir meses
      let meses = periodoTipo === "anos" ? periodo * 12 : periodo;

      // Converter juros anual para mensal
      let taxaMensal = Math.pow(1 + taxaJuros, 1/12) - 1;

      const historico = [];
      let saldo = valorInicial;
      historico.push(saldo);

      for (let i = 1; i <= meses; i++) {
        saldo = saldo * (1 + taxaMensal) + valorMensal;
        historico.push(saldo);
      }

      const totalInvestido = valorInicial + (valorMensal * meses);
      const rendimentoBruto = saldo - totalInvestido;
      
      let mensagemResultado = '';
      let valorFinalLiquido = saldo;
      
      if (calcularIRChecked && rendimentoBruto > 0) {
        const aliquotaIR = calcularAliquotaIR(meses);
        const valorIR = rendimentoBruto * aliquotaIR;
        valorFinalLiquido = saldo - valorIR;
        
        mensagemResultado = 'Valor final bruto: R$ ' + saldo.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '\n';
        mensagemResultado += 'Rendimento bruto: R$ ' + rendimentoBruto.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '\n';
        mensagemResultado += 'Alíquota IR: ' + (aliquotaIR * 100).toLocaleString('pt-BR', {minimumFractionDigits: 1}) + '%\n';
        mensagemResultado += 'Imposto de Renda: R$ ' + valorIR.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '\n';
        mensagemResultado += 'Valor final líquido: R$ ' + valorFinalLiquido.toLocaleString('pt-BR', {minimumFractionDigits: 2});
      } else {
        mensagemResultado = 'Valor final: R$ ' + saldo.toLocaleString('pt-BR', {minimumFractionDigits: 2});
      }

      const elementoResultado = document.getElementById('resultado');
      elementoResultado.innerText = mensagemResultado;
      elementoResultado.style.display = 'block'; // Mostra o resultado

      // Cria gráfico
      criarGrafico(historico, meses);
    }

    // Função para calcular planejamento (modo reverso)
    function calcularPlanejamento() {
      // Limpa erros anteriores
      limparErros();
      
      const valorFinal = extrairValorNumerico(document.getElementById('valorFinalDesejado').value, 'moeda');
      const valorInicial = extrairValorNumerico(document.getElementById('valorInicialPlan').value, 'moeda');
      const periodo = parseInt(document.getElementById('periodoPlan').value) || 0;
      const periodoTipo = document.getElementById('periodoTipoPlan').value;
      const calcularOpcao = document.getElementById('calcularOpcao').value;
      const calcularIRChecked = document.getElementById('calcularIRPlan').checked;
      
      // Validação básica
      let erros = [];
      
      if (!valorFinal || valorFinal <= 0) {
        document.getElementById('valorFinalDesejado').classList.add('erro-campo');
        erros.push('Valor final desejado');
      }
      
      if (!periodo || periodo <= 0) {
        document.getElementById('periodoPlan').classList.add('erro-campo');
        erros.push('Período');
      }
      
      if (calcularOpcao === 'aporte') {
        const taxaFixa = extrairValorNumerico(document.getElementById('taxaFixa').value, 'porcentagem');
        if (!taxaFixa || taxaFixa <= 0) {
          document.getElementById('taxaFixa').classList.add('erro-campo');
          erros.push('Taxa de juros estimada');
        }
      } else if (calcularOpcao === 'taxa') {
        const aporteFixo = extrairValorNumerico(document.getElementById('aporteFixo').value, 'moeda');
        if (!aporteFixo || aporteFixo <= 0) {
          document.getElementById('aporteFixo').classList.add('erro-campo');
          erros.push('Aporte mensal fixo');
        }
      } else if (calcularOpcao === 'inicial') {
        const taxaSemAporte = extrairValorNumerico(document.getElementById('taxaSemAporte').value, 'porcentagem');
        if (!taxaSemAporte || taxaSemAporte <= 0) {
          document.getElementById('taxaSemAporte').classList.add('erro-campo');
          erros.push('Taxa de juros estimada');
        }
      }
      
      if (erros.length > 0) {
        exibirErro(erros);
        limparResultado();
        return;
      }
      
      // Definir meses
      const meses = periodoTipo === "anos" ? periodo * 12 : periodo;
      
      let mensagemResultado = '';
      let historico = [];
      
      if (calcularOpcao === 'aporte') {
        // Calcular aporte mensal necessário
        const taxaAnual = extrairValorNumerico(document.getElementById('taxaFixa').value, 'porcentagem') / 100;
        const taxaMensal = Math.pow(1 + taxaAnual, 1/12) - 1;
        
        // Se considerar IR, precisamos ajustar o valor final desejado
        let valorFinalBruto = valorFinal;
        if (calcularIRChecked) {
          const aliquotaIR = calcularAliquotaIR(meses);
          // Fórmula: VF_liquido = VF_bruto - (VF_bruto - Total_Investido) * aliquota
          // Resolvendo para VF_bruto quando sabemos VF_liquido
          // Esta é uma aproximação iterativa
          valorFinalBruto = valorFinal * 1.2; // Chute inicial
        }
        
        // Fórmula: PMT = (FV - PV * (1 + i)^n) / (((1 + i)^n - 1) / i)
        const fatorCrescimento = Math.pow(1 + taxaMensal, meses);
        const valorFinalInicial = valorInicial * fatorCrescimento;
        const diferenca = valorFinalBruto - valorFinalInicial;
        
        let aporteMensal = 0;
        if (taxaMensal > 0) {
          aporteMensal = diferenca / ((fatorCrescimento - 1) / taxaMensal);
        } else {
          aporteMensal = diferenca / meses;
        }
        
        // Recalcula considerando o IR se necessário
        if (calcularIRChecked && aporteMensal > 0) {
          // Ajuste iterativo para encontrar o aporte que resulta no valor líquido desejado
          for (let iter = 0; iter < 10; iter++) {
            let saldoTemp = valorInicial;
            for (let i = 1; i <= meses; i++) {
              saldoTemp = saldoTemp * (1 + taxaMensal) + aporteMensal;
            }
            const totalInvestidoTemp = valorInicial + (aporteMensal * meses);
            const rendimentoTemp = saldoTemp - totalInvestidoTemp;
            const aliquotaIR = calcularAliquotaIR(meses);
            const irTemp = rendimentoTemp * aliquotaIR;
            const valorLiquidoTemp = saldoTemp - irTemp;
            
            const erro = valorLiquidoTemp - valorFinal;
            if (Math.abs(erro) < 1) break; // Precisão de R$ 1,00
            
            // Ajusta o aporte
            aporteMensal += erro / meses;
          }
        }
        
        // Recalcula o valor final real com o aporte ajustado
        let saldoFinal = valorInicial;
        for (let i = 1; i <= meses; i++) {
          saldoFinal = saldoFinal * (1 + taxaMensal) + aporteMensal;
        }
        
        const totalInvestido = valorInicial + (aporteMensal * meses);
        const rendimentoBruto = saldoFinal - totalInvestido;
        
        // Se aporte calculado for negativo, significa que o valor inicial já supera o objetivo
        if (aporteMensal < 0) {
          mensagemResultado = 'O valor inicial já é suficiente para atingir seu objetivo!\n\n';
          mensagemResultado += 'Com a taxa informada, seu investimento inicial de R$ ' + 
            valorInicial.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + 
            ' chegará a R$ ' + valorFinalInicial.toLocaleString('pt-BR', {minimumFractionDigits: 2}) +
            ' no período especificado.';
          aporteMensal = 0;
        } else {
          mensagemResultado = 'Aporte mensal necessário: R$ ' + 
            aporteMensal.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '\n\n';
          
          if (calcularIRChecked && rendimentoBruto > 0) {
            const aliquotaIR = calcularAliquotaIR(meses);
            const valorIR = rendimentoBruto * aliquotaIR;
            const valorLiquido = saldoFinal - valorIR;
            
            mensagemResultado += 'Valor final bruto: R$ ' + saldoFinal.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '\n';
            mensagemResultado += 'Total investido: R$ ' + totalInvestido.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '\n';
            mensagemResultado += 'Rendimento bruto: R$ ' + rendimentoBruto.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '\n';
            mensagemResultado += 'Alíquota IR: ' + (aliquotaIR * 100).toLocaleString('pt-BR', {minimumFractionDigits: 1}) + '%\n';
            mensagemResultado += 'Imposto de Renda: R$ ' + valorIR.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '\n';
            mensagemResultado += 'Valor final líquido: R$ ' + valorLiquido.toLocaleString('pt-BR', {minimumFractionDigits: 2});
          } else {
            mensagemResultado += 'Total investido: R$ ' + totalInvestido.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '\n';
            mensagemResultado += 'Rendimento: R$ ' + rendimentoBruto.toLocaleString('pt-BR', {minimumFractionDigits: 2});
          }
        }
        
        // Gera histórico
        let saldo = valorInicial;
        historico.push(saldo);
        for (let i = 1; i <= meses; i++) {
          saldo = saldo * (1 + taxaMensal) + aporteMensal;
          historico.push(saldo);
        }
        
      } else if (calcularOpcao === 'inicial') {
        // Calcular valor inicial necessário (sem aportes mensais)
        const taxaAnual = extrairValorNumerico(document.getElementById('taxaSemAporte').value, 'porcentagem') / 100;
        const taxaMensal = Math.pow(1 + taxaAnual, 1/12) - 1;
        
        // Fórmula: PV = FV / (1 + i)^n
        const fatorDesconto = Math.pow(1 + taxaMensal, meses);
        let valorInicialNecessario = valorFinal / fatorDesconto;
        
        // Se considerar IR, precisamos ajustar
        if (calcularIRChecked) {
          const aliquotaIR = calcularAliquotaIR(meses);
          // Ajuste iterativo para encontrar o valor inicial que resulta no valor líquido desejado
          for (let iter = 0; iter < 20; iter++) {
            const valorFinalBruto = valorInicialNecessario * fatorDesconto;
            const rendimentoBruto = valorFinalBruto - valorInicialNecessario;
            const irTemp = rendimentoBruto * aliquotaIR;
            const valorLiquidoTemp = valorFinalBruto - irTemp;
            
            const erro = valorLiquidoTemp - valorFinal;
            if (Math.abs(erro) < 1) break; // Precisão de R$ 1,00
            
            // Ajusta o valor inicial
            valorInicialNecessario += erro / fatorDesconto;
          }
        }
        
        const valorFinalBruto = valorInicialNecessario * fatorDesconto;
        const rendimentoBruto = valorFinalBruto - valorInicialNecessario;
        
        mensagemResultado = 'Valor inicial necessário: R$ ' + 
          valorInicialNecessario.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '\n\n';
        mensagemResultado += 'Investindo esse valor único, sem aportes mensais, você terá:\n';
        
        if (calcularIRChecked && rendimentoBruto > 0) {
          const aliquotaIR = calcularAliquotaIR(meses);
          const valorIR = rendimentoBruto * aliquotaIR;
          const valorLiquido = valorFinalBruto - valorIR;
          
          mensagemResultado += 'Valor final bruto: R$ ' + valorFinalBruto.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '\n';
          mensagemResultado += 'Rendimento bruto: R$ ' + rendimentoBruto.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '\n';
          mensagemResultado += 'Alíquota IR: ' + (aliquotaIR * 100).toLocaleString('pt-BR', {minimumFractionDigits: 1}) + '%\n';
          mensagemResultado += 'Imposto de Renda: R$ ' + valorIR.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '\n';
          mensagemResultado += 'Valor final líquido: R$ ' + valorLiquido.toLocaleString('pt-BR', {minimumFractionDigits: 2});
        } else {
          mensagemResultado += 'Valor final: R$ ' + valorFinalBruto.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '\n';
          mensagemResultado += 'Rendimento: R$ ' + rendimentoBruto.toLocaleString('pt-BR', {minimumFractionDigits: 2});
        }
        
        // Gera histórico
        let saldo = valorInicialNecessario;
        historico.push(saldo);
        for (let i = 1; i <= meses; i++) {
          saldo = saldo * (1 + taxaMensal);
          historico.push(saldo);
        }
        
      } else {
        // Calcular taxa de juros necessária
        const aporteMensal = extrairValorNumerico(document.getElementById('aporteFixo').value, 'moeda');
        
        // Cálculo iterativo da taxa (usando método de Newton-Raphson simplificado)
        let taxaMensal = 0.01; // Chute inicial: 1% ao mês
        const precisao = 0.0001;
        const maxIteracoes = 1000;
        
        for (let iter = 0; iter < maxIteracoes; iter++) {
          let saldo = valorInicial;
          let derivada = 0;
          
          // Calcula o valor final com a taxa atual
          for (let i = 1; i <= meses; i++) {
            derivada += saldo * i;
            saldo = saldo * (1 + taxaMensal) + aporteMensal;
          }
          
          const erro = saldo - valorFinal;
          
          if (Math.abs(erro) < precisao) break;
          
          // Ajusta a taxa
          if (derivada !== 0) {
            taxaMensal -= erro / derivada;
          } else {
            break;
          }
          
          // Garante que a taxa não fique negativa
          if (taxaMensal < 0) taxaMensal = 0.0001;
        }
        
        const taxaAnualCalculada = (Math.pow(1 + taxaMensal, 12) - 1) * 100;
        
        // Verifica se é possível atingir o objetivo
        const totalInvestido = valorInicial + (aporteMensal * meses);
        if (totalInvestido > valorFinal) {
          mensagemResultado = 'Atenção: O valor final desejado é menor que o total a ser investido!\n\n';
          mensagemResultado += 'Total a investir: R$ ' + totalInvestido.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '\n';
          mensagemResultado += 'Valor final desejado: R$ ' + valorFinal.toLocaleString('pt-BR', {minimumFractionDigits: 2});
        } else {
          mensagemResultado = 'Taxa de juros necessária: ' + 
            taxaAnualCalculada.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '% ao ano\n\n';
          mensagemResultado += 'Total investido: R$ ' + totalInvestido.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '\n';
          mensagemResultado += 'Rendimento: R$ ' + 
            (valorFinal - totalInvestido).toLocaleString('pt-BR', {minimumFractionDigits: 2});
        }
        
        // Gera histórico
        let saldo = valorInicial;
        historico.push(saldo);
        for (let i = 1; i <= meses; i++) {
          saldo = saldo * (1 + taxaMensal) + aporteMensal;
          historico.push(saldo);
        }
      }
      
      // Exibe resultado
      const elementoResultado = document.getElementById('resultado');
      elementoResultado.innerText = mensagemResultado;
      elementoResultado.style.display = 'block';
      
      // Cria gráfico
      criarGrafico(historico, meses);
    }

    // Função auxiliar para criar o gráfico
    function criarGrafico(historico, meses) {
      // Criar labels dos meses
      let labels = [];
      for (let i = 0; i <= meses; i++) {
        labels.push(i + "º mês");
      }

      // Destruir gráfico antigo antes de recriar
      if (chart) {
        chart.destroy();
      }

      let ctx = document.getElementById('grafico').getContext('2d');
      
      // Mostra o canvas antes de criar o gráfico
      document.getElementById('grafico').style.display = 'block';
      
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Evolução do investimento',
            data: historico,
            borderColor: '#3949ab',
            backgroundColor: 'rgba(57,73,171,0.2)',
            fill: true,
            tension: 0.2
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: false,
              ticks: {
                callback: function(value) {
                  return 'R$ ' + value.toLocaleString('pt-BR');
                }
              }
            }
          }
        }
      });
    }
    
    // Adicionar event listeners para limpar resultado quando campos são editados
    document.addEventListener('DOMContentLoaded', function() {
      const campos = ['valorInicial', 'valorMensal', 'taxaJuros', 'periodo', 'periodoTipo', 'calcularIR'];
      
      campos.forEach(campoId => {
        const campo = document.getElementById(campoId);
        if (campo) {
          const evento = campo.type === 'checkbox' ? 'change' : 'input';
          campo.addEventListener(evento, function() {
            limparResultado();
            limparErros();
          });
        }
      });
      
      // Event listeners para modo planejamento
      const camposPlan = ['valorFinalDesejado', 'valorInicialPlan', 'periodoPlan', 'periodoTipoPlan', 'taxaFixa', 'aporteFixo', 'taxaSemAporte', 'calcularIRPlan'];
      
      camposPlan.forEach(campoId => {
        const campo = document.getElementById(campoId);
        if (campo) {
          const evento = campo.type === 'checkbox' ? 'change' : 'input';
          campo.addEventListener(evento, function() {
            limparResultado();
            limparErros();
          });
        }
      });
      
      // Event listener para alternância de opção de cálculo
      const calcularOpcao = document.getElementById('calcularOpcao');
      if (calcularOpcao) {
        calcularOpcao.addEventListener('change', function() {
          atualizarCamposPlanejamento();
          limparResultado();
          limparErros();
        });
      }
    });
  </script>
</body>
</html>
